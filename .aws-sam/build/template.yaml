AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: AI Content Detector - Fixed CORS
Globals:
  Function:
    Timeout: 30
    Runtime: python3.11
    MemorySize: 512
  Api:
    Cors:
      AllowMethods: '''GET,POST,OPTIONS'''
      AllowHeaders: '''Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'''
      AllowOrigin: '''*'''
      MaxAge: '''600'''
Resources:
  AnalyzeFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AnalyzeFunction
      Handler: text-detector.lambda_handler
      Runtime: python3.11
      Policies:
      - Statement:
          Effect: Allow
          Action:
          - bedrock:InvokeModel
          Resource: '*'
      - Statement:
          Effect: Allow
          Action:
          - comprehend:DetectSentiment
          - comprehend:DetectKeyPhrases
          Resource: '*'
      - Statement:
          Effect: Allow
          Action:
          - dynamodb:PutItem
          Resource:
            Fn::GetAtt:
            - ContentDetectionsTable
            - Arn
      Events:
        Api:
          Type: Api
          Properties:
            Path: /analyze
            Method: post
        ApiOptions:
          Type: Api
          Properties:
            Path: /analyze
            Method: options
      Environment:
        Variables:
          TABLE_NAME:
            Ref: ContentDetectionsTable
          BEDROCK_REGION: us-east-1
    Metadata:
      SamResourceId: AnalyzeFunction
  DocumentDetectorFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: DocumentDetectorFunction
      Handler: document-detector.lambda_handler
      Runtime: python3.11
      Timeout: 300
      MemorySize: 1024
      Policies:
      - Statement:
          Effect: Allow
          Action:
          - bedrock:InvokeModel
          Resource: '*'
      - Statement:
          Effect: Allow
          Action:
          - comprehend:DetectSentiment
          - comprehend:DetectKeyPhrases
          Resource: '*'
      - Statement:
          Effect: Allow
          Action:
          - dynamodb:PutItem
          Resource:
            Fn::GetAtt:
            - ContentDetectionsTable
            - Arn
      - Statement:
          Effect: Allow
          Action:
          - s3:GetObject
          - s3:GetObjectVersion
          - s3:HeadObject
          - s3:PutObject
          - s3:PutObjectAcl
          Resource:
          - arn:aws:s3:::ai-detection-documents/*
      - Statement:
          Effect: Allow
          Action:
          - s3:ListBucket
          Resource:
          - arn:aws:s3:::ai-detection-documents
      Events:
        Api:
          Type: Api
          Properties:
            Path: /process-document
            Method: post
        ApiOptions:
          Type: Api
          Properties:
            Path: /process-document
            Method: options
      Environment:
        Variables:
          TABLE_NAME:
            Ref: ContentDetectionsTable
          BEDROCK_REGION: us-east-1
          DATA_REGION:
            Ref: AWS::Region
          BUCKET_NAME: ai-detection-documents
    Metadata:
      SamResourceId: DocumentDetectorFunction
  ImageDetectorFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ImageDetectorFunction
      Handler: image-detector.lambda_handler
      Runtime: python3.11
      Timeout: 300
      MemorySize: 2048
      Policies:
      - Statement:
          Effect: Allow
          Action:
          - bedrock:InvokeModel
          Resource: '*'
      - Statement:
          Effect: Allow
          Action:
          - dynamodb:PutItem
          Resource:
            Fn::GetAtt:
            - ContentDetectionsTable
            - Arn
      - Statement:
          Effect: Allow
          Action:
          - s3:GetObject
          - s3:GetObjectVersion
          - s3:HeadObject
          - s3:PutObject
          - s3:PutObjectAcl
          Resource:
          - arn:aws:s3:::ai-detection-images/*
      - Statement:
          Effect: Allow
          Action:
          - s3:ListBucket
          Resource:
          - arn:aws:s3:::ai-detection-images
      Events:
        Api:
          Type: Api
          Properties:
            Path: /process-image
            Method: post
        ApiOptions:
          Type: Api
          Properties:
            Path: /process-image
            Method: options
      Environment:
        Variables:
          TABLE_NAME:
            Ref: ContentDetectionsTable
          BEDROCK_REGION: us-east-1
          DATA_REGION: ap-southeast-5
          BUCKET_NAME: ai-detection-images
    Metadata:
      SamResourceId: ImageDetectorFunction
  ContentDetectionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ContentDetections
      AttributeDefinitions:
      - AttributeName: id
        AttributeType: S
      - AttributeName: timestamp
        AttributeType: S
      KeySchema:
      - AttributeName: id
        KeyType: HASH
      - AttributeName: timestamp
        KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
Outputs:
  ApiUrl:
    Description: API Gateway endpoint URL for Text Analyze function
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/analyze
  DocumentDetectorApiUrl:
    Description: API Gateway endpoint URL for Document Detector function
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/process-document
  ImageDetectorApiUrl:
    Description: API Gateway endpoint URL for Image Detector function
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/process-image
  DocumentsBucketName:
    Description: S3 bucket name for document storage
    Value: ai-detection-documents
  ImagesBucketName:
    Description: S3 bucket name for image storage
    Value: ai-detection-images
  DynamoDBTableName:
    Description: DynamoDB table name for storing analysis results
    Value:
      Ref: ContentDetectionsTable
  TextDetectorFunctionName:
    Description: Lambda function name for text detection
    Value:
      Ref: AnalyzeFunction
  DocumentDetectorFunctionName:
    Description: Lambda function name for document detection
    Value:
      Ref: DocumentDetectorFunction
